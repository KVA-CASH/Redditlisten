<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¯ Pain Point Sniper - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .severe { border-left: 4px solid #ef4444; }
        .moderate { border-left: 4px solid #f59e0b; }
        .mild { border-left: 4px solid #eab308; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .scroll-container { max-height: 600px; overflow-y: auto; }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Header -->
    <header class="p-6 border-b border-white/10">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <span class="text-4xl">ðŸŽ¯</span>
                <div>
                    <h1 class="text-2xl font-bold">Pain Point Sniper</h1>
                    <p class="text-gray-400 text-sm">Sentiment-Aware Reddit Monitor</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="status" class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full pulse"></span>
                    <span class="text-sm text-gray-400">Live</span>
                </div>
                <button onclick="refreshData()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                    ðŸ”„ Refresh
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="card rounded-xl p-6">
                <div class="text-gray-400 text-sm mb-1">Total Pain Points</div>
                <div id="total-count" class="text-3xl font-bold">0</div>
            </div>
            <div class="card rounded-xl p-6 severe">
                <div class="text-gray-400 text-sm mb-1">ðŸ”´ Severe</div>
                <div id="severe-count" class="text-3xl font-bold text-red-500">0</div>
            </div>
            <div class="card rounded-xl p-6 moderate">
                <div class="text-gray-400 text-sm mb-1">ðŸŸ  Moderate</div>
                <div id="moderate-count" class="text-3xl font-bold text-orange-500">0</div>
            </div>
            <div class="card rounded-xl p-6 mild">
                <div class="text-gray-400 text-sm mb-1">ðŸŸ¡ Mild</div>
                <div id="mild-count" class="text-3xl font-bold text-yellow-500">0</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Pain Points Feed -->
            <div class="lg:col-span-2">
                <div class="card rounded-xl">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">ðŸ“‹ Recent Pain Points</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="filterSeverity(null)" class="px-3 py-1 text-sm bg-white/10 hover:bg-white/20 rounded-lg transition filter-btn active">All</button>
                            <button onclick="filterSeverity('SEVERE')" class="px-3 py-1 text-sm bg-red-500/20 hover:bg-red-500/30 rounded-lg transition filter-btn">Severe</button>
                            <button onclick="filterSeverity('MODERATE')" class="px-3 py-1 text-sm bg-orange-500/20 hover:bg-orange-500/30 rounded-lg transition filter-btn">Moderate</button>
                            <button onclick="sortByPain()" class="px-3 py-1 text-sm bg-purple-500/20 hover:bg-purple-500/30 rounded-lg transition" id="sort-btn">ðŸ“Š Most Painful</button>
                        </div>
                    </div>
                    <div id="pain-points-feed" class="scroll-container p-4 space-y-3">
                        <div class="text-center text-gray-500 py-8">Loading pain points...</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Top Keywords -->
                <div class="card rounded-xl">
                    <div class="p-4 border-b border-white/10">
                        <h2 class="text-lg font-semibold">ðŸ”¥ Top Pain Keywords</h2>
                    </div>
                    <div id="keywords-list" class="p-4 space-y-2">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>

                <!-- Niches -->
                <div class="card rounded-xl">
                    <div class="p-4 border-b border-white/10">
                        <h2 class="text-lg font-semibold">ðŸ“Š By Niche</h2>
                    </div>
                    <div id="niches-list" class="p-4 space-y-2">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>

                <!-- Top Subreddits -->
                <div class="card rounded-xl">
                    <div class="p-4 border-b border-white/10">
                        <h2 class="text-lg font-semibold">ðŸ’¬ Top Subreddits</h2>
                    </div>
                    <div id="subreddits-list" class="p-4 space-y-2">
                        <div class="text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentFilter = null;
        let painPoints = [];

        // Niche colors and emojis
        const nicheStyles = {
            'Sweaty_Startup': { emoji: 'ðŸ”§', color: 'yellow' },
            'Agency_Owners': { emoji: 'ðŸ“Š', color: 'cyan' },
            'Ecommerce_Ops': { emoji: 'ðŸ›’', color: 'purple' },
            'Content_Creators': { emoji: 'ðŸŽ¬', color: 'green' },
            'Recruiters': { emoji: 'ðŸ‘”', color: 'blue' },
        };

        // Socket.IO connection
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('status').innerHTML = `
                <span class="w-3 h-3 bg-green-500 rounded-full pulse"></span>
                <span class="text-sm text-gray-400">Live</span>
            `;
        });

        socket.on('disconnect', () => {
            document.getElementById('status').innerHTML = `
                <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                <span class="text-sm text-gray-400">Disconnected</span>
            `;
        });

        socket.on('new_pain_point', (data) => {
            // Add to top of feed
            painPoints.unshift(data.pain_point);
            renderPainPoints();
            refreshStats();
        });

        // Fetch and display stats
        async function refreshStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                document.getElementById('total-count').textContent = data.total;
                document.getElementById('severe-count').textContent = data.severity.SEVERE;
                document.getElementById('moderate-count').textContent = data.severity.MODERATE;
                document.getElementById('mild-count').textContent = data.severity.MILD;

                // Keywords
                const keywordsHtml = data.keywords.slice(0, 10).map((k, i) => `
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">${k.keyword}</span>
                        <span class="text-xs bg-red-500/30 px-2 py-0.5 rounded-full">${k.count}</span>
                    </div>
                `).join('');
                document.getElementById('keywords-list').innerHTML = keywordsHtml || '<div class="text-gray-500 text-sm">No data yet</div>';

                // Niches
                const nichesHtml = data.niches.map(n => {
                    const style = nicheStyles[n.niche] || { emoji: 'ðŸ””', color: 'gray' };
                    return `
                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm">${style.emoji} ${n.niche.replace('_', ' ')}</span>
                            <span class="text-xs bg-${style.color}-500/30 px-2 py-0.5 rounded-full">${n.count}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('niches-list').innerHTML = nichesHtml || '<div class="text-gray-500 text-sm">No data yet</div>';

                // Subreddits
                const subredditsHtml = data.subreddits.slice(0, 8).map(s => `
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">r/${s.subreddit}</span>
                        <span class="text-xs bg-blue-500/30 px-2 py-0.5 rounded-full">${s.count}</span>
                    </div>
                `).join('');
                document.getElementById('subreddits-list').innerHTML = subredditsHtml || '<div class="text-gray-500 text-sm">No data yet</div>';

            } catch (err) {
                console.error('Failed to fetch stats:', err);
            }
        }

        // Fetch pain points
        async function fetchPainPoints() {
            try {
                const url = currentFilter
                    ? `/api/pain-points?severity=${currentFilter}&limit=100`
                    : '/api/pain-points?limit=100';
                const res = await fetch(url);
                const data = await res.json();
                painPoints = data.pain_points;
                renderPainPoints();
            } catch (err) {
                console.error('Failed to fetch pain points:', err);
            }
        }

        // Render pain points
        function renderPainPoints() {
            const container = document.getElementById('pain-points-feed');

            if (painPoints.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No pain points found yet. Start the listener!</div>';
                return;
            }

            const html = painPoints.map(p => {
                const severityClass = p.severity === 'SEVERE' ? 'severe' : p.severity === 'MODERATE' ? 'moderate' : 'mild';
                const severityEmoji = p.severity === 'SEVERE' ? 'ðŸ”´' : p.severity === 'MODERATE' ? 'ðŸŸ ' : 'ðŸŸ¡';
                const nicheStyle = nicheStyles[p.niche] || { emoji: 'ðŸ””', color: 'gray' };
                const timestamp = new Date(p.timestamp).toLocaleString();
                const contextPreview = p.context_snippet ? p.context_snippet.substring(0, 150) + (p.context_snippet.length > 150 ? '...' : '') : '';

                return `
                    <div class="card rounded-lg p-4 ${severityClass} hover:bg-white/5 transition">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span>${severityEmoji}</span>
                                <span class="font-semibold text-red-400">${p.keyword}</span>
                                <span class="text-xs bg-${nicheStyle.color}-500/30 px-2 py-0.5 rounded-full">${nicheStyle.emoji} ${p.niche.replace('_', ' ')}</span>
                            </div>
                            <span class="text-xs text-gray-500">${p.pain_score}</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">"${contextPreview}"</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <div class="flex items-center gap-3">
                                <span>r/${p.subreddit}</span>
                                <span>u/${p.author}</span>
                            </div>
                            <a href="${p.reddit_url.replace('old.reddit.com', 'www.reddit.com')}" target="_blank" class="text-blue-400 hover:text-blue-300">View Post â†’</a>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Filter by severity
        function filterSeverity(severity) {
            currentFilter = severity;
            sortByPainActive = false;
            document.getElementById('sort-btn').classList.remove('ring-2', 'ring-white/50');

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'ring-2', 'ring-white/50');
            });
            event.target.classList.add('active', 'ring-2', 'ring-white/50');

            fetchPainPoints();
        }

        // Sort by most painful (lowest score first)
        let sortByPainActive = false;
        function sortByPain() {
            sortByPainActive = !sortByPainActive;
            const btn = document.getElementById('sort-btn');

            if (sortByPainActive) {
                btn.classList.add('ring-2', 'ring-white/50');
                btn.textContent = 'ðŸ“Š Most Painful âœ“';
                // Sort by pain_score (most negative first)
                painPoints.sort((a, b) => a.pain_score - b.pain_score);
            } else {
                btn.classList.remove('ring-2', 'ring-white/50');
                btn.textContent = 'ðŸ“Š Most Painful';
                // Sort by timestamp (newest first)
                painPoints.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            renderPainPoints();
        }

        // Refresh all data
        function refreshData() {
            refreshStats();
            fetchPainPoints();
        }

        // Initial load
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
